{% extends "base.html" %}

{% block head %}
  {% block title %}Google Map{% endblock %}
  <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      /*#map {
        height: 60%;
      }
       Optional: Makes the sample page fill the window. 
      html, body {
        height: 60%;
        margin: 0;
        padding: 0;
      }*/
    </style>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.1/Chart.js'></script>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
{% endblock %}


{% block content %}

<div class="container-fluid">
  <div class="row">
    <div class="col-10" id="map"></div> <!-- reserves a spot for the map -->
    <div class="col-2">
        <div id="crime_buttons">
          
          <input type="checkbox" name="filter" id="Vandalism" class='chk-btn' checked>
          <label for='vandalism'>Vandalism</label>
          
          <input type="checkbox" name="filter" id="Assault" class='chk-btn' checked>
          <label for='assault'>Assault</label>
          
          <input type="checkbox" name="filter" id="Theft/Larceny" class='chk-btn' checked>
          <label for='theft larceny'>Theft/Larceny</label>

          <input type="checkbox" name="filter" id="Robbery" class='chk-btn' checked>
          <label for='robbery'>Robbery</label>

          <input type="checkbox" name="filter" id="Disturbing The Peace" class='chk-btn' checked>
          <label for='disturbing the peace'>Disturbing the Peace</label>

          <input type="checkbox" name="filter" id="Motor Vehicle Theft" class='chk-btn' checked>
          <label for='motor vehicle theft'>Motor Vehicle Theft</label>

          <input type="checkbox" name="filter" id="Burglary" class='chk-btn' checked>
          <label for='burglary'>Burglary</label>

          <input type="checkbox" name="filter" id="Weapons" class='chk-btn' checked>
          <label for='weapons'>Weapons</label>

          <input type="checkbox" name="filter" id="Sex Crimes" class='chk-btn' checked>
          <label for='sex crimes'>Sex Crimes</label>

          <input type="checkbox" name="filter" id="Drugs/Alcohol Violations" class='chk-btn' checked>
          <label for='drugs and alcohol violations'>Drugs/Alcohol Violations</label>

          <input type="checkbox" name="filter" id="Arson" class='chk-btn' checked>
          <label for='arson'>Arson</label>
            
          <input type="checkbox" name="filter" id="Homicide" class='chk-btn' checked>
          <label for='homicide'>Homicide</label>

          <input type="checkbox" name="filter" id="Fraud" class='chk-btn' checked>
          <label for='fraud'>Fraud</label>

          <input type="checkbox" name="filter" id="Dui" class='chk-btn' checked>
          <label for='dui'>DUI</label>
          <br>
        </div>

        <div id="home_filter">
          <p>Filter homes by price</p>
          <label for='minimum price'>Minimum Price: </label>
          <input type="text" name="hfilter" id="min_price" class='home_price'>

          <label for='maximum price'>Maximum Price: </label>
          <input type="text" name="hfilter" id="max_price" class='home_price'>

          <label for='submit'></label>
          <input type="submit" name="hfilter" id="submit" class='home_price'>
        </div>
    </div>
    <div class="row" id="chart">
      <div class="col-12">
        <canvas id="crime_type_chart"></canvas>
      </div>
    </div> 
  </div>       
</div>
    <script>
      "use strict";
      let map;
      const crimeData = {{ crime_data|tojson }};
      const homeForSaleData = {{ homes_for_sale_data|tojson }};
      const crimeChartData = {{ chart_dict|tojson }};
      let crimesToFilter = []; // used for filtering crime types
      let homePricesToFilter = []; // used for filtering home prices
      let markers = []; // used for populating markers on the map
      let filteredCrimes = [];
      let filteredHomes = [];
      // filters default to false so all crimes are shown
      let crimeFilters = {'Vandalism':false, 'Assault':false, 'Theft/Larceny':false, 
                          'Robbery':false, 'Disturbing The Peace':false, 
                          'Motor Vehicle Theft':false, 'Burglary':false, 
                          'Weapons':false, 'Sex Crimes':false, 
                          'Drugs/Alcohol Violations':false, 
                          'Arson':false, 'Homicide':false, 'Fraud':false, 
                          'Dui':false};
                

      // adds an event listener to the checkboxes looking for a change
      // calls map_filter function. 
      $('input[name=filter]').change(function (e) {
       filterCrimes(this.id);
      });


      // toggles the value in the crimeFilters array.
      // if value is false, it's changed to true and vice versa
      // add all the crimeFilters that are false to crimesToFilter because
      // want to keep the markers on the map that are in crimesToFilter.
      // because there are many items that can be filtered, the crimeFilters
      // step is necessary.
      function filterCrimes(id_val) {
        if (crimeFilters[id_val]) {
          crimeFilters[id_val] = false
        } else {
          crimeFilters[id_val] = true
          crimesToFilter.push(id_val);
        }
        filterData(crimeData, crimesToFilter);
      }


      // adds event listener to the submit button for filtering homes by price
      $('#submit').click(function (e) {
        filterPrices(homeForSaleData);
      });

      // Loop through homeForSaleData and check if house's price is 
      // between the min and max prices entered by user
      // populates homePricesToFilter
      function filterPrices(data) {
        for (let house of data) {
          if (house.price <= $('#min_price').val()) {
            homePricesToFilter.push(house.price);
          }
          if (house.price >= $('#max_price').val()) {
            homePricesToFilter.push(house.price);
          }
        }
        filterData(homeForSaleData, homePricesToFilter);
      }
      

      // Takes in the markers that have been added to the map and filters based on
      // the filter data being passed in.
      function filterData(data, filterData) {
        if (filterData === crimesToFilter) {
          filteredCrimes = data.filter(crime => !crimesToFilter.includes(crime.crime_type));
          addfilteredMarkers();
        } 
        if (filterData === homePricesToFilter) {
          filteredHomes = data.filter(home => !homePricesToFilter.includes(home.price));
          addfilteredMarkers();    
        }
      }


      function addfilteredMarkers() {
        deleteMarkers();
        if (filteredCrimes.length !=0 && filteredHomes.length != 0) {
          addMarkers(filteredCrimes);
          addMarkers(filteredHomes);
        } 
        else if (filteredCrimes.length !=0) {
          addMarkers(filteredCrimes);
          addMarkers(homeForSaleData);
        } 
        else {
          addMarkers(crimeData);
          addMarkers(filteredHomes);
        }
      }

     
      function initMap() {

        const mapCenter = {lat: {{ input_lat }}, lng: {{ input_lng }}};
        
        // instantiate a new map object with the input address
        // as the center of the map.
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 16,
          center: mapCenter
        }); 
     
        // Add a marker for the center point of the map
        let inputMarker = new google.maps.Marker({
          position: mapCenter,
          label: 'Test',
          map: map
        });

        addMarkers(crimeData);
        addMarkers(homeForSaleData);
        makeCrimeChart(crimeChartData);
      }


      function addMarkers(data) {
        // note: data is an array of dictionaries
        // loop over each item(dictionary) in data array
        for (let i=0; i < data.length; i++) { 

          let mapIcon;

          if (data[0].case_num) {
            mapIcon = "static/angry_emoji.png";
          }
          else {
            mapIcon = "static/house_icon.png";
          }
          // create a new marker object for each item(dictionary)
          // using the lat/lng in the item for the position
          let marker = new google.maps.Marker({
            position: {lat: data[i]['lat'], lng: data[i]['lng']},
            map: map,
            icon: mapIcon
          });
          // add the marker to the markers array in the global scope
          markers.push(marker);

          let infoWindowContent;

          // if data is crime data, use this infoWindow content
          if (data[0].case_num) {
            infoWindowContent = `<div id="crimeInfo">
              <ul style="list-style-type:none">
              <li><b>Type of Crime:</b> ${data[i].crime_type}</li>
              <li>Date and Time of Occurance: ${data[i].date_time}</li>
              <li>Case Number: ${data[i].case_num}</li>
              <li>Description of Crime: ${data[i].description}</li>
              <li>Police Beat: ${data[i].police_beat}</li>
              <li>Agency: Oakland Police Department</li>
              </ul>
              </div>`;
          // else data is home data so use this infoWindow content    
          } else {
            infoWindowContent = `<div id="homeInfo">
              <ul style="list-style-type:none">
                <li><b>Address:</b> ${data[i].street_adrs} ${data[i].city}, ${data[i].state}</li>
                <li><b>Neighborhood:</b> ${data[i].neighborhood}</li>
                <li><b>Price:</b> $${data[i].price}</li>
                <li><b>Days on the Market:</b> ${data[i].days_on_market}</li>
                <li><b>Type of Property:</b> ${data[i].property_type}</li>
                <li><b>Year Built:</b> ${data[i].year_built}</li>
                <li><b>Square Footage:</b> ${data[i].sq_ft}</li>
                <li><b>Price per Square Foot:</b> $${data[i].price_per_sqft}</li>
                <li><b>Number of Bedrooms:</b> ${data[i].num_bed}</li>
                <li><b>Number of Bathrooms:</b> ${data[i].num_bath}</li>
                <li><b>Lot Size(ft):</b> ${data[i].lot_size}</li>
                <li><b>HOA Dues per Month:</b> $${data[i].hoa_per_month}</li>
                <li><b>MLS number:</b> ${data[i].mls_num} </li>
              </ul>
              </div>`;
          }
          // create an infoWindow object for each marker
          let infowindow = new google.maps.InfoWindow({
            content: infoWindowContent
          });

          // add an event listener to each marker
          marker.addListener('click', function() {
           infowindow.open(map, marker);
          });
        }
        // loop through markers array and set them all on the map.
        setMapOnAll(map);
      }

        // Sets the map on all markers in the array.
      function setMapOnAll(map) {
        for (let i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }

      // Removes the markers from the map, but keeps them in the array.
      function clearMarkers() {
        setMapOnAll(null);
      }

      // Shows any markers currently in the array.
      function showMarkers() {
        setMapOnAll(map);
      }

      // Deletes all markers in the array by removing references to them.
      function deleteMarkers() {
        clearMarkers();
        markers = [];
      }
 
      
      function makeCrimeChart(data) {

      // data coming in will look like this:
      // data = {'labels': ['Vandalism', 'Assault', 'Motor Vehicle Theft', 
      //         'Theft/Larceny', 'Burglary', 'Robbery', 'Disturbing The Peace', 
      //         'Dui', 'Weapons', 'Fraud'], 
      //         'data': [19, 26, 27, 94, 8, 7, 7, 2, 2, 5]}   
        const context = $("#crime_type_chart");

        const crimeChart = new Chart(context, {
              type: 'bar',
              data: {
                  labels: data.labels,
                  datasets: [{
                      label: 'Number of Crime per type',
                      data: data.data,
                      backgroundColor: [
                          'rgba(255, 99, 132, 0.2)',
                          'rgba(54, 162, 235, 0.2)',
                          'rgba(255, 206, 86, 0.2)',
                          'rgba(75, 192, 192, 0.2)',
                          'rgba(153, 102, 255, 0.2)',
                          'rgba(255, 159, 64, 0.2)'
                      ],
                      borderColor: [
                          'rgba(255,99,132,1)',
                          'rgba(54, 162, 235, 1)',
                          'rgba(255, 206, 86, 1)',
                          'rgba(75, 192, 192, 1)',
                          'rgba(153, 102, 255, 1)',
                          'rgba(255, 159, 64, 1)'
                      ],
                      borderWidth: 1
                  }]
              },
              options: {
                  scales: {
                      yAxes: [{
                          ticks: {
                              beginAtZero:true
                          }
                      }]
                  }
              }
          });
      }
      

      
      


    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ gkey }}&callback=initMap"
    async defer></script> 
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
{% endblock %}